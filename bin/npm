#!/bin/bash
NPM='/usr/bin/npm'

function contains() {
	local element
	for element in "${@:2}"
	do
		if [[ "$element" == "$1" ]]
		then
			return 0
		fi
	done
	return 1
}

has_lock=
if [[ ! -s "/tmp/$(whoami)/.npmrc" ]]
then
	has_lock=yes
	cat "$(dirname "$(readlink "$HOME/.zshrc")")/.npmrc" > "/tmp/$(whoami)/.npmrc"
fi

if [[ $has_lock ]] && contains "$1" 'publish'
then
	credentials="$(pass npm)"
	cat <<-EOF | "$NPM" login
	$(echo "$credentials" | awk '/Username/ {print $2}')
	$(echo "$credentials" | head -1)
	$(echo "$credentials" | awk '/Email/ {print $2}')
	EOF
	"$NPM" "$@"
	code=$?
	"$NPM" logout
else
	"$NPM" "$@"
	code=$?
fi

if [[ $has_lock ]]
then
	printf '' > "/tmp/$(whoami)/.npmrc"
fi

exit $code
